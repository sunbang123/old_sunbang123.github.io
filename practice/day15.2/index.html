<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>스마트디바이스 실습15.2주차</title>
        <link rel="icon" type="image/x-icon" href="assets/img/favicon.ico" />
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:500,700" rel="stylesheet" type="text/css" />
        <link href="https://fonts.googleapis.com/css?family=Muli:400,400i,800,800i" rel="stylesheet" type="text/css" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="../../css/styles.css" rel="stylesheet" />
    </head>
    <body id="page-top">
        <!-- Navigation-->
        <nav class="pt-sm-5 navbar navbar-expand-lg navbar-dark bg-primary fixed-top" id="sideNav">
            <div id="nav-top">

            </div>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="../../index.html">portfolio</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="#smart-device">스마트디바이스란?</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="#Sum">요약</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="#End">배운점</a></li>
                </ul>
            </div>
        </nav>
        <!-- Page Content-->
        <div class="container-fluid p-0">
            <!-- About-->
            <section class="resume-section pb-1" id="about">
                <div class="resume-section-content">
                    <h3 class="mb-0">
                        스마트 디바이스 실습 15.2주차
                    </h3>
                    <div class="subheading mb-3">
                        aws & node red
                    </div>
                    <p class="lead">
                        한세대학교 컴퓨터공학과 22학번 김선영
                    </p>
                </div>
            </section>
            <hr class="m-0" />
            <!-- Experience-->
            <section class="resume-section" id="experience">
                <div class="resume-section-content mb-5">
                    <h3 class="mb-4">Node-Red</h3>
                    Node-Red
                    <ol>
                        <li>비주얼 프로그래밍 툴로서, IoT 프로젝트 및 자동화 워크플로우를 구축하기 위해 사용됨.</li>
                        <li>Node.js 기반으로 동작하며, 사용자는 브라우저 기반의 그래픽 인터페이스를 통해 흐름(flow)을 생성하고 제어할 수 있음.</li>
                        <li>Node-RED는 미리 정의된 노드(Node)를 사용하여 다양한 기기 및 서비스 간의 데이터 흐름을 구축</li>
                        <li>데이터를 변환, 처리 및 저장할 수 있음.</li>
                        <li>센서 데이터를 수집하고, 데이터베이스에 저장하고, 알림을 보내는 등의 작업을 자동화할 수 있음.</li>
                    </ol>

                        Node-RED와 AWS의 연관성
                    <ol>

                        <li>비주얼 프로그래밍 툴로서, IoT 프로젝트 및 자동화 워크플로우를 구축하기 위해 사용됨.</li>
                        <li>Node.js 기반으로 동작하며, 사용자는 브라우저 기반의 그래픽 인터페이스를 통해 흐름(flow)을 생성하고 제어할 수 있음.</li>
                        <li>Node-RED는 미리 정의된 노드(Node)를 사용하여 다양한 기기 및 서비스 간의 데이터 흐름을 구축</li>
                        <li>데이터를 변환, 처리 및 저장할 수 있음.</li>
                        <li>센서 데이터를 수집하고, 데이터베이스에 저장하고, 알림을 보내는 등의 작업을 자동화할 수 있음.</li>
                    </ol>
                    <hr class="mt-5">

                    <div id="diagram" class="d-flex flex-column flex-md-row justify-content-between mb-3 mt-5">
                            <div class="flex-grow-1">
                            <h3>실습 1 : aws & node-red</h3>
                            <img src="https://github.com/sunbang123/Smart_device/assets/93497158/8be23b56-9329-4930-91aa-645d6fbec1f4" class="img-fluid" alt="Responsive image">
                            <br><br>
                            <h5 class="mt-3">실습 순서</h5>
                            aws
                                <ol>
                                    <li>사물 정책을 추가.</li>
                                    <img src="https://github.com/sunbang123/Smart_device/assets/93497158/88bbd768-02c6-4b0b-9692-713b9b93a976" class="img-fluid" alt="Responsive image">

                                </ol>
                                <ol>
                                    <li>Node-RED 실행:</li>
                                    터미널에서 다음 명령어를 실행하여 Node-RED를 시작.


                                    <br>
                                    <pre><code>
    $ node-red                                     
                                    </code></pre>
                                    <br>
                                    "Started flows" 메시지가 표시되면 로컬에서 실행 중임.
                                    <br>
                                    <br>
                                    <li>Node-RED 접속:
                                    </li>
                                    브라우저에서 http://localhost:1880 로 접속.
                                    <br><br>
                                    <li>노드 추가:</li>

                                    노드 구성

                                    <br>

                                    <img src="https://github.com/sunbang123/Smart_device/assets/93497158/929a1c80-5506-48f8-a9f1-cef799c67aa5"  class="img-fluid width-400" alt="Responsive image">
                                    <br><br>

                                    <li>Inject 노드 설정:</li>

                                    <img src="https://github.com/sunbang123/Smart_device/assets/93497158/5c5dfbfa-a2b2-41be-8380-c012d7fc7bb6"  class="img-fluid" alt="Responsive image">
                                    <br><br>

                                    <li>MQTT Out 노드 설정:</li>

                                    MQTT Out 노드

                                    <br>

                                    <img src="https://github.com/sunbang123/Smart_device/assets/93497158/62615957-b1a1-49bb-91bf-9a7cea135f9f"  class="img-fluid" alt="Responsive image">
                                    <br><br>


                                    MQTT Out broker 노드

                                    <br>

                                    <img src="https://github.com/sunbang123/Smart_device/assets/93497158/af3ff86e-75e3-4f81-8b16-6f1672bc180e"  class="img-fluid" alt="Responsive image">
                                    <br><br>


                                    MQTT Out tls-config 노드

                                    <br>

                                    <img src="https://github.com/sunbang123/Smart_device/assets/93497158/4bce648c-3237-4a6c-bf79-f11cfb479590"  class="img-fluid" alt="Responsive image">
                                    <br><br>

                                    <li>MQTT In 노드도 이와 같이 배치.</li>
                                    

                                    <br><br>
                                    <li>AWS에서 주제 구독(Topic Subscribe)를 선택하고 해당 토픽을 구독.</li>
                                    <img src="https://github.com/sunbang123/Smart_device/assets/93497158/a4f67cf7-91a0-48ef-a969-a7e4ae3fe283"  class="img-fluid" alt="Responsive image">

                                    <br><br>
                                    <li>Node-RED에서 발행한 메시지를 확인할 수 있음.</li>
                                    <img src="https://github.com/sunbang123/Smart_device/assets/93497158/ec14b31e-bbf5-4ef7-ac2a-2dc236f48bdc"  class="img-fluid width-400" alt="Responsive image">
                                </ol>
                                </div>
                            </div>

                                <hr class="mt-5"/>

                                <div class="flex-grow-1">
                                    <h3>실습 2 : 온습도값 AWS mqtt & Node-RED 출력</h3>
                                    <img src="https://github.com/sunbang123/Smart_device/assets/93497158/8be23b56-9329-4930-91aa-645d6fbec1f4" class="img-fluid" alt="Responsive image">
                                    <br><br>
                                    <h5 class="mt-3">실습 순서</h5>
                                        <ol>
                                            <li>Node-RED 접속:
                                            </li>
                                            브라우저에서 http://localhost:1880 로 접속.
                                            <br><br>
                                            <li>노드 추가:</li>
        
                                            노드 구성
        
                                            <br>
        
                                            <img src="https://github.com/sunbang123/Smart_device/assets/93497158/972702a1-3810-4684-a850-5436b58db076"  class="img-fluid" alt="Responsive image">
                                            <br><br>
        
                                            <li>MQTT Out 노드 설정:</li>
        
                                            - topic을 esp32/pub으로 바꿈.
                                            <br><br>
        
                                            <li>function 노드 설정:</li>
                                            - humidity
                                            <br><br>
        
<pre><code>
    msg.payload = msg.payload.humidity;
    return msg;
</code></pre>
                                            <br>
                                            - temperature
                                            <br><br>
        
<pre><code>
    msg.payload = msg.payload.temperature;
    return msg;
</code></pre>
<br><br>
        
                                            
                                            <li>결과 확인</li>
                                            <br>
                                            - Serial Monitor
                                            <br>
                                            <img src="https://github.com/sunbang123/Smart_device/assets/93497158/889982bc-fe7a-4629-85bc-d4c0f184a419" class="img-fluid width-400" alt="Responsive image">
                                            <br><br>
                                            
                                            - node-red debug
                                            <br>
                                            <img src="https://github.com/sunbang123/Smart_device/assets/93497158/711ffc54-2b34-4a2f-bebe-13738acf099a" class="img-fluid width-400" alt="Responsive image">
                                            
                                            <br><br>
                                            - node-red dashboard
                                            <br>
                                            <img src="https://github.com/sunbang123/Smart_device/assets/93497158/ae81e580-2f1e-478f-a01c-d34044444efd" class="img-fluid" alt="Responsive image">
                                            <br><br>
                                        </ol>
                                        </div>
                                    
                        <div class="flex-grow-1">
                            <h3 class="mt-4 mb-4">코드</h3>
                        <pre>
                            <code>
    #include "secrets.h"
    #include &lg;WiFiClientSecure.h>
    #include &lg;MQTTClient.h>
    #include &lg;ArduinoJson.h>
    #include &lg;DHT.h>
    #include &lg;WiFi.h>
    
    // AWS IoT 설정
    #define AWS_IOT_PUBLISH_TOPIC   "esp32/pub"
    #define AWS_IOT_SUBSCRIBE_TOPIC "esp32/sub"
    
    // DHT11 센서 설정
    #define DHT_PIN 13       // DHT11 데이터 핀
    #define DHT_TYPE DHT11  // DHT11 센서
    
    WiFiClientSecure net;
    MQTTClient client;
    
    DHT dht(DHT_PIN, DHT_TYPE);
    
    void connectAWS()
    {
        WiFi.mode(WIFI_STA);
        WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
    
        Serial.println("Connecting to Wi-Fi");
    
        while (WiFi.status() != WL_CONNECTED){
        delay(500);
        Serial.print(".");
        }
    
        // Configure WiFiClientSecure to use the AWS IoT device credentials
        net.setCACert(AWS_CERT_CA);
        net.setCertificate(AWS_CERT_CRT);
        net.setPrivateKey(AWS_CERT_PRIVATE);
    
        // Connect to the MQTT broker on the AWS endpoint we defined earlier
        client.begin(AWS_IOT_ENDPOINT, 8883, net);
    
        // Create a message handler
        client.onMessage(messageHandler);
    
        Serial.print("Connecting to AWS IoT");
    
        while (!client.connect(THINGNAME)) {
        Serial.print(".");
        delay(100);
        }
    
        if(!client.connected()){
        Serial.println("AWS IoT Timeout!");
        return;
        }
    
        // Subscribe to a topic
        client.subscribe(AWS_IOT_SUBSCRIBE_TOPIC);
    
        Serial.println("AWS IoT Connected!");
    }
    
    void publishMessage(float temperature, float humidity)
    {
        StaticJsonDocument&lg;200> doc;
        doc["temperature"] = temperature;
        doc["humidity"] = humidity;
        char jsonBuffer[512];
        serializeJson(doc, jsonBuffer);
    
        client.publish(AWS_IOT_PUBLISH_TOPIC, jsonBuffer);
    }
    
    void messageHandler(String &topic, String &payload) {
        Serial.println("incoming: " + topic + " - " + payload);
    }
    
    void setup() {
        Serial.begin(9600);
        connectAWS();
        dht.begin();
    }
    
    void loop() {
        // 온습도 데이터 읽기
        float temperature = dht.readTemperature();
        float humidity = dht.readHumidity();
        Serial.println(temperature);
        Serial.println(humidity);
    
        // 온습도 데이터를 Node-RED로 전송
        // JSON 형식으로 데이터를 생성하여 MQTT 메시지로 전송
        StaticJsonDocument&lg;200> doc;
        doc["temperature"] = temperature;
        doc["humidity"] = humidity;
        char jsonBuffer[512];
        serializeJson(doc, jsonBuffer);
        client.publish("node-red/esp32-data", jsonBuffer); // Node-RED에서 subscribe할 토픽을 "node-red/esp32-data"로 지정
    
        // AWS IoT에도 데이터를 전송
        publishMessage(temperature, humidity);
    
        // AWS IoT 클라이언트 루프
        client.loop();
    
        delay(1000);
    }                            
</code></pre>
    </div>

                    <hr class="mb-5">
                    <div id="End" class="d-flex flex-column flex-md-row justify-content-between mb-5">
                        <div class="flex-grow-1">
                            <h4 class="mb-3">느낀점</h4>
                            <ol style="list-style-type:inherit">
                                <li>성공적으로 실습을 끝내고 지난 시간에 배웠던 내용을 응용해서 node-red 실습을 할 수 있어서 좋았음.</li>
                                <li>node-red와 같은 오픈소스 비주얼 프로그래밍 툴 사용법을 익히고 mqtt와 mqtt브로커에 대해서 배울 수 있었음.</li>
                            </ol>
                        </div>

                        </div>
                    <hr class="mb-3">
                    <a style="text-align: left;" href="../day15.1/index.html">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-caret-left-fill" viewBox="0 0 16 16">
                            <path d="m3.86 8.753 5.482 4.796c.646.566 1.658.106 1.658-.753V3.204a1 1 0 0 0-1.659-.753l-5.48 4.796a1 1 0 0 0 0 1.506z"/>
                          </svg>
                        Previous
                    </a>
                    <span>&nbsp;&nbsp;/&nbsp;&nbsp;</span>
                </div>
            </div>
            </div>
                </div>
            </section>
            <hr class="m-0" />
        </div>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="../../js/scripts.js"></script>
    </body>
</html>